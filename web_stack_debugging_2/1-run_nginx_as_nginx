#!/usr/bin/env bash
# Securely configure Nginx to run as nginx user on port 8080

# Exit on error
set -e

# Step 1: Ensure nginx user exists
if ! id nginx >/dev/null 2>&1; then
  useradd -r -s /usr/sbin/nologin nginx
fi

# Step 2: Install Nginx if not already installed
apt update -y
apt install -y nginx

# Step 3: Change user in main nginx.conf
if grep -q "^user" /etc/nginx/nginx.conf; then
  sed -i 's/^user .*/user nginx;/' /etc/nginx/nginx.conf
else
  sed -i '1iuser nginx;' /etc/nginx/nginx.conf
fi

# Step 4: Change port in site config to 8080
sed -i 's/listen 80 default_server;/listen 8080 default_server;/' /etc/nginx/sites-available/default
sed -i 's/listen \[::\]:80 default_server;/listen [::]:8080 default_server;/' /etc/nginx/sites-available/default

# Step 5: Fix permissions so nginx user can access logs and cache
chown -R nginx:nginx /var/log/nginx
chown -R nginx:nginx /var/cache/nginx

# Step 6: Test config and restart Nginx
nginx -t
service nginx restart
